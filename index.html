<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Salary Clarity Finder</title>
<meta name="description" content="Paste a job posting and get a transparency score, law check by state, and a market pay estimate. Local-only, no uploads." />
<style>
  :root{
    --bg:#0b1020; --panel:#0f1530; --ink:#e8edff; --muted:#9db0ff; --line:#202848;
    --brand:#7aa2ff; --good:#30dd89; --warn:#ffcd55; --bad:#ff6b6b; --alt:#0c1230;
    --radius:14px; --radius-sm:10px;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  header h1{margin:0;font-size:18px;font-weight:800}
  header .sub{font-size:12px;color:var(--muted)}
  main{max-width:1100px;margin:0 auto;padding:18px}
  .grid{display:grid;gap:18px;grid-template-columns:1fr 1fr}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
  textarea,input,button,select{font-weight:600}
  textarea{width:100%;min-height:280px;background:var(--alt);color:var(--ink);border:1px solid var(--line);border-radius:var(--radius-sm);padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace}
  input[type=url], select{width:100%;background:#10183a;border:1px solid var(--line);border-radius:var(--radius-sm);padding:10px;color:var(--ink)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{appearance:none;border:1px solid var(--line);background:#10183a;color:var(--ink);padding:10px 14px;border-radius:var(--radius-sm);cursor:pointer}
  .btn.primary{background:var(--brand);border-color:transparent;color:#0a0f22}
  .pill{border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0}
  .bar{height:10px;background:#121a3a;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%}
  h2{margin:4px 0 10px;font-size:16px}
  .list{display:grid;gap:8px}
  .item{padding:10px 12px;border:1px dashed var(--line);border-radius:10px}
  .item.bad{border-color:#3a1d1d;background:#1a0f12}
  .item.warn{border-color:#4a3a18;background:#141008}
  .item.good{border-color:#213a2a;background:#0e1712}
  .muted{color:var(--muted);font-size:12px}
  .score-wrap{display:flex;align-items:center;gap:12px}
  .score{font-size:40px;font-weight:800}
  .small{font-size:12px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.two{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div>
    <h1>Salary Clarity Finder</h1>
    <div class="sub">Transparency score • Law check by state • Market pay estimate (beta) • Local-only</div>
  </div>
  <div class="sub">by Jeremy • v1.1</div>
</header>

<main class="grid">
  <section class="card">
    <h2>1) Paste job posting</h2>
    <textarea id="jd" placeholder="Paste the full job ad here (or paste a URL below and copy the posting text here to avoid CORS)"></textarea>
    <div class="controls two">
      <div>
        <input id="url" type="url" placeholder="Optional: job posting URL (used to hint location/domain)"/>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="sample">Load sample</button>
        <button class="btn" id="clear">Clear</button>
        <button class="btn primary" id="analyze">Analyze</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">No servers, no tracking. Everything runs in your browser.</div>
  </section>

  <section class="card" id="results">
    <h2>2) Score & compliance</h2>
    <div class="score-wrap">
      <div class="score" id="total">–</div>
      <div class="pill" id="verdict">Awaiting input</div>
    </div>

    <div class="row"><span>Salary shown</span><span id="s_salary">–</span></div>
    <div class="bar"><span id="b_salary" style="width:0;background:var(--bad)"></span></div>

    <div class="row"><span>Location clarity</span><span id="s_loc">–</span></div>
    <div class="bar"><span id="b_loc" style="width:0;background:var(--bad)"></span></div>

    <div class="row"><span>Benefits/comp details</span><span id="s_ben">–</span></div>
    <div class="bar"><span id="b_ben" style="width:0;background:var(--bad)"></span></div>

    <div class="row"><span>EEO/DEI statement</span><span id="s_eeo">–</span></div>
    <div class="bar"><span id="b_eeo" style="width:0;background:var(--bad)"></span></div>

    <div class="row"><span>Application path</span><span id="s_apply">–</span></div>
    <div class="bar"><span id="b_apply" style="width:0;background:var(--bad)"></span></div>

    <div class="row"><span>Range quality (min–max)</span><span id="s_quality">–</span></div>
    <div class="bar"><span id="b_quality" style="width:0;background:var(--bad)"></span></div>

    <div class="row"><span>Law compliance (detected state)</span><span id="s_law">–</span></div>
    <div class="bar"><span id="b_law" style="width:0;background:var(--bad)"></span></div>

    <div class="two" style="margin-top:10px">
      <div class="card" style="background:var(--alt)">
        <h2>Detected</h2>
        <div class="list" id="detected"></div>
      </div>
      <div class="card" style="background:var(--alt)">
        <h2>Fixes</h2>
        <div class="list" id="flags"></div>
      </div>
    </div>

    <!-- NEW: Market Pay Estimator -->
    <div class="card" style="margin-top:10px;background:var(--alt)">
      <h2>Market Pay Estimate (beta)</h2>
      <div class="small muted">Heuristic suggestion based on title/level + metro cost multipliers. Use judgment; adjust for equity/bonus.</div>
      <div class="two" style="margin-top:10px">
        <div>
          <div class="row"><span>Detected role</span><span id="m_role" class="pill">—</span></div>
          <div class="row"><span>Detected level</span><span id="m_level" class="pill">—</span></div>
          <div class="row"><span>Detected metro</span><span id="m_metro" class="pill">—</span></div>
        </div>
        <div>
          <label class="small muted">Adjust metro multiplier</label>
          <select id="m_multiplier">
            <option value="1.25">Bay Area (1.25)</option>
            <option value="1.20">NYC (1.20)</option>
            <option value="1.15">San Diego (1.15)</option>
            <option value="1.12">Seattle (1.12)</option>
            <option value="1.10" selected>Boston/Cambridge (1.10)</option>
            <option value="1.05">Austin/Denver (1.05)</option>
            <option value="1.00">US Remote / Other (1.00)</option>
            <option value="0.90">Low-cost metros (0.90)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px"><strong>Suggested base range</strong><span id="m_range" style="font-weight:800">—</span></div>
      <div class="row"><span>Confidence</span><span id="m_conf" class="pill">—</span></div>
      <div class="controls">
        <button class="btn" id="insertEstimate">Insert estimate into summary</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px;background:var(--alt)">
      <h2>Copyable summary</h2>
      <div class="small muted">Paste this as a comment or send to a recruiter.</div>
      <textarea id="summary" class="small" style="min-height:120px;margin-top:8px"></textarea>
      <div class="controls"><button class="btn" id="copy">Copy summary</button></div>
    </div>
  </section>
</main>

<script>
// ------- Helpers -------
const STATES = {
  "AL":"Alabama","AK":"Alaska","AZ":"Arizona","AR":"Arkansas","CA":"California","CO":"Colorado","CT":"Connecticut","DC":"District of Columbia","DE":"Delaware","FL":"Florida","GA":"Georgia","HI":"Hawaii","ID":"Idaho","IL":"Illinois","IN":"Indiana","IA":"Iowa","KS":"Kansas","KY":"Kentucky","LA":"Louisiana","ME":"Maine","MD":"Maryland","MA":"Massachusetts","MI":"Michigan","MN":"Minnesota","MS":"Mississippi","MO":"Missouri","MT":"Montana","NE":"Nebraska","NV":"Nevada","NH":"New Hampshire","NJ":"New Jersey","NM":"New Mexico","NY":"New York","NC":"North Carolina","ND":"North Dakota","OH":"Ohio","OK":"Oklahoma","OR":"Oregon","PA":"Pennsylvania","RI":"Rhode Island","SC":"South Carolina","SD":"South Dakota","TN":"Tennessee","TX":"Texas","UT":"Utah","VT":"Vermont","VA":"Virginia","WA":"Washington","WV":"West Virginia","WI":"Wisconsin","WY":"Wyoming"
};

// Jurisdictions with known salary-range posting requirements (concise; not exhaustive).
const LAW_RULES = [
  {code:"CA", name:"California", effective:"2023-01-01", threshold:1},
  {code:"CO", name:"Colorado", effective:"2021-01-01", threshold:1},
  {code:"WA", name:"Washington", effective:"2023-01-01", threshold:15},
  {code:"NY", name:"New York (statewide)", effective:"2023-09-17", threshold:4},
  {code:"HI", name:"Hawaii", effective:"2024-01-01", threshold:50},
  {code:"IL", name:"Illinois", effective:"2025-01-01", threshold:15},
  {code:"MA", name:"Massachusetts", effective:"2025-10-29", threshold:25},
];

function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }
function isEffective(date){ return todayISO() >= date; }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function bar(id,val){ const el=document.getElementById(id); el.style.width = clamp(val,0,100)+"%"; el.style.background = val>=80?"var(--good)":val>=60?"var(--warn)":"var(--bad)"; }

// ------- Detection -------
function detectStates(text, url){
  const hits = new Set();
  const t = (text||"").toLowerCase();
  Object.entries(STATES).forEach(([abbr,name])=>{
    const reName = new RegExp("\\b"+name.toLowerCase().replace(/\./g,'\\.')+"\\b","i");
    const reAbbr = new RegExp("\\b"+abbr+"\\b","i");
    if (reName.test(t) || reAbbr.test(t)) hits.add(abbr);
  });
  if(url){
    const u=url.toLowerCase();
    Object.entries(STATES).forEach(([abbr,name])=>{
      if (u.includes(name.toLowerCase()) || u.match(new RegExp("[ ,/]+"+abbr.toLowerCase()+"([ ,/]|$)"))) hits.add(abbr);
    });
  }
  return Array.from(hits);
}

function parseSalary(text){
  const range = /(\$?\s?\d{2,3}(?:,\d{3})?\s?(?:k|K)?)[\s\-–—to]{1,3}(\$?\s?\d{2,3}(?:,\d{3})?\s?(?:k|K)?)/;
  const hasRange = range.test(text);
  const dollars = /\$\s?\d{2,3}(?:,\d{3})?(?:\.\d{2})?/g;
  const found = text.match(dollars)||[];
  const hourly = /\$\s?\d{1,3}(?:\.\d{2})?\s*\/(?:hour|hr)/i.test(text);
  const perYear = /per\s+(year|annum|yr)/i.test(text);
  return {hasAny: found.length>0 || hasRange, hasRange, hasHourly:hourly, hasPerYear:perYear, examples: (text.match(/\$[^\s.,;)]{1,12}/g)||[]).slice(0,4)};
}

function detectBenefits(text){
  const keys=["benefits","medical","health","dental","vision","401k","retirement","pto","paid time","bonus","equity","stock","rsu","stipend"];
  const lower=text.toLowerCase();
  return keys.filter(k=>lower.includes(k)).length;
}

function detectEEO(text){ return /(equal opportunity|eeo|we welcome applicants|accommodations)/i.test(text); }
function detectApply(text){ return /(apply|application|to be considered|submit|greenhouse|workday|lever|ashby|careers@|jobs@|apply now)/i.test(text); }

function lawStatus(states){
  if(!states.length) return {label:"Unknown (no state detected)", score:50, detail:"Add a clear location (state or remote with HQ)."};
  let requiresNow=false, requiresSoon=false, soonDate=null, hit=null;
  for(const abbr of states){
    const rule = LAW_RULES.find(r=>r.code===abbr);
    if(!rule) continue;
    hit = rule;
    if(isEffective(rule.effective)) { requiresNow = true; break; }
    else { requiresSoon = true; soonDate = rule.effective; }
  }
  if(requiresNow){ return {label:`Posting must include salary range in ${hit.name}`, score:100, detail:`Active as of ${hit.effective}.`}; }
  if(requiresSoon){ return {label:`Law pending in ${hit.name}`, score:65, detail:`Takes effect ${hit.effective}. Add ranges now to be compliant.`}; }
  return {label:"Posting requirement not confirmed for detected state(s)", score:70, detail:"Good practice: include a good-faith range + benefits."};
}

// ------- NEW: Market pay estimator -------
const ROLE_TABLE = [
  // ---- Wet Lab / R&D ----
  {family:"Research Assistant", level:"I",   re:/\b(research\s+assistant\s*(?:i|1)?|lab\s+assistant)\b/i, low:50000,  high:70000},
  {family:"Research Assistant", level:"II",  re:/\b(research\s+assistant\s*(?:ii|2))\b/i,                low:60000,  high:80000},
  {family:"Research Associate", level:"I",   re:/\b(research\s+associate\s*(?:i|1)?|ra\s*i)\b/i,         low:65000,  high:85000},
  {family:"Research Associate", level:"II",  re:/\b(research\s+associate\s*(?:ii|2)|ra\s*ii)\b/i,        low:85000,  high:105000},
  {family:"Research Associate", level:"III", re:/\b(research\s+associate\s*(?:iii|3)|senior\s+research\s+associate)\b/i, low:100000, high:125000},
  {family:"Scientist",          level:"I",   re:/\b(scientist\s*(?:i|1)|associate\s+scientist)\b/i,      low:110000, high:140000},
  {family:"Scientist",          level:"II",  re:/\b(scientist\s*(?:ii|2))\b/i,                           low:130000, high:165000},
  {family:"Senior Scientist",   level:"—",   re:/\b(senior\s+scientist|sr\.\s*scientist)\b/i,            low:150000, high:190000},
  {family:"Principal Scientist",level:"—",   re:/\b(principal\s+scientist|staff\s+scientist)\b/i,        low:175000, high:220000},
  {family:"Lab Technician",     level:"—",   re:/\b(lab(?:oratory)?\s+technician|lab\s+tech)\b/i,        low:48000,  high:65000},
  {family:"Lab Manager",        level:"—",   re:/\b(lab(?:oratory)?\s+manager|lab\s+operations\s+manager)\b/i, low:90000,  high:120000},
  {family:"Molecular Biologist",level:"—",   re:/\b(molecular\s+biolog(ist|y))\b/i,                      low:110000, high:150000},
  {family:"Cell Biologist",     level:"—",   re:/\b(cell\s+biolog(ist|y))\b/i,                           low:110000, high:150000},
  {family:"Immunologist",       level:"—",   re:/\b(immunolog(ist|y))\b/i,                               low:120000, high:170000},
  {family:"Protein Scientist",  level:"—",   re:/\b(protein\s+(chemist|scientist)|protein\s+engineer)\b/i, low:120000, high:170000},
  {family:"Analytical Scientist",level:"—",  re:/\b(analytical\s+scientist|bioanalytical)\b/i,           low:120000, high:170000},
  {family:"Process Development Scientist", level:"—", re:/\b(process\s+development|downstream|upstream)\s+(scientist|engineer)\b/i, low:125000, high:180000},
  {family:"Formulation Scientist", level:"—",re:/\b(formulation\s+scientist)\b/i,                        low:115000, high:165000},
  {family:"Automation Engineer (Lab)", level:"—", re:/\b(lab\s+automation|liquid\s+handling|hamilton|tecan)\b/i, low:115000, high:160000},

  // ---- Manufacturing / MSAT / CMC ----
  {family:"Manufacturing Associate", level:"I",  re:/\b(manufacturing\s+associate\s*(?:i|1)|bioprocess\s+associate\s*(?:i|1))\b/i, low:60000,  high:80000},
  {family:"Manufacturing Associate", level:"II", re:/\b(manufacturing\s+associate\s*(?:ii|2)|bioprocess\s+associate\s*(?:ii|2))\b/i, low:70000, high:90000},
  {family:"Senior Manufacturing Associate", level:"—", re:/\b(senior\s+manufacturing\s+associate)\b/i,   low:85000,  high:105000},
  {family:"Manufacturing Technician", level:"—", re:/\b(manufacturing\s+technician|upstream\s+tech|downstream\s+tech)\b/i, low:55000, high:75000},
  {family:"MSAT Scientist/Engineer", level:"—",  re:/\b(msat|manufacturing\s+science\s+and\s+technology)\b/i, low:115000, high:160000},
  {family:"Process Engineer",        level:"—",  re:/\b(process\s+engineer|bioprocess\s+engineer)\b/i,   low:110000, high:150000},
  {family:"CMC Project Manager",     level:"—",  re:/\b(cmc\s+(project|program)\s+manager)\b/i,          low:135000, high:180000},

  // ---- Quality: QC / QA / Validation ----
  {family:"QC Analyst",   level:"I/II", re:/\b(qc|quality\s+control).*(analyst|associate)\b/i,           low:60000,  high:90000},
  {family:"Senior QC Analyst", level:"—", re:/\b(senior\s+qc\s+analyst|sr\.\s+qc)\b/i,                   low:90000,  high:110000},
  {family:"QC Microbiologist", level:"—", re:/\b(qc\s+micro|microbiolog(ist|y))\b/i,                     low:65000,  high:95000},
  {family:"QA Specialist",     level:"I/II", re:/\b(qa|quality\s+assurance).*(specialist|associate)\b/i, low:75000,  high:105000},
  {family:"Senior QA Specialist", level:"—", re:/\b(senior\s+qa\s+specialist|sr\.\s+qa)\b/i,             low:100000, high:125000},
  {family:"QA Manager",        level:"—",   re:/\b(qa\s+manager|quality\s+assurance\s+manager)\b/i,      low:120000, high:150000},
  {family:"Validation Engineer", level:"—", re:/\b(validation\s+engineer|csv|equipment\s+validation)\b/i,low:100000, high:140000},
  {family:"GxP Quality Lead",  level:"—",   re:/\b(gxp\s+quality|quality\s+lead|quality\s+head)\b/i,     low:150000, high:200000},

  // ---- Clinical / Biometrics ----
  {family:"Clinical Research Coordinator", level:"—", re:/\b(clinical\s+research\s+coordinator|crc)\b/i, low:52000,  high:75000},
  {family:"Clinical Trial Assistant",      level:"—", re:/\b(clinical\s+trial\s+assistant|cta)\b/i,      low:52000,  high:70000},
  {family:"Clinical Project Manager",      level:"—", re:/\b(clinical\s+(project|study)\s+manager|cpm)\b/i, low:120000, high:165000},
  {family:"Clinical Operations Manager",   level:"—", re:/\b(clinical\s+operations\s+manager|clops)\b/i, low:120000, high:170000},
  {family:"CRA (Monitor)",                 level:"—", re:/\b(clinical\s+research\s+associate|cra)\b/i,   low:90000,  high:130000},
  {family:"Clinical Data Manager",         level:"—", re:/\b(clinical\s+data\s+manager|cdm)\b/i,         low:110000, high:150000},
  {family:"Biostatistician",               level:"I/II", re:/\b(biostatistician|biostats)\b/i,           low:130000, high:175000},
  {family:"Senior Biostatistician",        level:"—",   re:/\b(senior\s+biostatistician|principal\s+biostat)\b/i, low:160000, high:210000},
  {family:"Medical Writer",                level:"—",   re:/\b(medical\s+writer|regulatory\s+writer)\b/i,low:110000, high:155000},
  {family:"Pharmacovigilance Specialist",  level:"—",   re:/\b(pharmacovigilance|drug\s+safety|pv)\b/i,  low:100000, high:145000},

  // ---- Regulatory Affairs ----
  {family:"Regulatory Affairs Associate",  level:"—", re:/\b(regulatory\s+affairs\s+associate|ra\s+associate)\b/i, low:90000,  high:120000},
  {family:"Regulatory Affairs Manager",    level:"—", re:/\b(regulatory\s+affairs\s+manager|ra\s+manager)\b/i,     low:130000, high:170000},
  {family:"Senior/Director Regulatory",    level:"—", re:/\b(senior|director)\s+regulatory\s+affairs\b/i,         low:170000, high:230000},

  // ---- Data / Software / Computation ----
  {family:"Bioinformatician",      level:"—", re:/\b(bioinformatic(s|ian)|ngs\s+analysis|rna-?seq|single-?cell)\b/i, low:130000, high:180000},
  {family:"Computational Biologist",level:"—", re:/\b(computational\s+biolog(ist|y))\b/i,                   low:130000, high:185000},
  {family:"Data Scientist (Bio)",  level:"—", re:/\b(data\s+scientist|ml\s+scientist)\b/i,                 low:130000, high:180000},
  {family:"ML/AI Engineer",        level:"—", re:/\b(ml|machine\s+learning|ai)\s+(engineer|developer)\b/i,  low:145000, high:200000},
  {family:"Data Engineer",         level:"—", re:/\b(data\s+engineer|etl|warehouse)\b/i,                   low:130000, high:180000},
  {family:"Software Engineer",     level:"I–III", re:/\b(software\s+engineer|full-?stack|frontend|backend)\b/i, low:120000, high:180000},
  {family:"DevOps/SRE",            level:"—", re:/\b(devops|sre|platform\s+engineer)\b/i,                  low:135000, high:185000},
  {family:"LIMS Engineer/Admin",   level:"—", re:/\b(lims|labware|benchling)\b/i,                          low:115000, high:160000},

  // ---- Product / Design ----
  {family:"Product Manager",       level:"—", re:/\b(product\s+manager|pm)\b/i,                            low:130000, high:180000},
  {family:"UX/UI Designer",        level:"—", re:/\b(ux|ui|product\s+designer)\b/i,                        low:110000, high:160000},
  {family:"Technical Writer",      level:"—", re:/\b(technical\s+writer|documentation)\b/i,               low:90000,  high:130000},

  // ---- GxP Ops / Facilities / EHS / Supply Chain ----
  {family:"Facilities Technician", level:"—", re:/\b(facilities\s+tech|maintenance\s+tech)\b/i,           low:55000,  high:80000},
  {family:"Facilities Manager",    level:"—", re:/\b(facilities\s+manager|site\s+manager)\b/i,            low:110000, high:150000},
  {family:"EHS Specialist",        level:"—", re:/\b(ehs|environmental\s+health\s+and\s+safety)\b/i,      low:90000,  high:125000},
  {family:"Supply Chain Planner",  level:"—", re:/\b(supply\s+chain\s+planner|demand\s+planner)\b/i,      low:90000,  high:125000},
  {family:"Procurement Specialist",level:"—", re:/\b(procurement|buyer|purchasing)\b/i,                   low:80000,  high:115000},
  {family:"Warehouse/Inventory Lead", level:"—", re:/\b(warehouse|inventory)\s+(lead|manager)\b/i,        low:65000,  high:95000},

  // ---- HR / Talent / People ----
  {family:"Recruiter / Talent Partner", level:"—", re:/\b(recruiter|talent\s+acquisition|ta\s+partner)\b/i, low:85000, high:130000},
  {family:"HR Generalist",              level:"—", re:/\b(hr\s+generalist|people\s+operations)\b/i,         low:80000, high:115000},
  {family:"HRBP / People Partner",      level:"—", re:/\b(hrbp|people\s+partner|hr\s+business\s+partner)\b/i, low:110000, high:155000},

  // ---- Finance / Admin / Legal ----
  {family:"FP&A Analyst",          level:"—", re:/\b(fp&a|financial\s+planning|financial\s+analyst)\b/i,  low:95000,  high:130000},
  {family:"Accountant",            level:"—", re:/\b(accountant|staff\s+accountant|senior\s+accountant)\b/i, low:75000, high:110000},
  {family:"Office Manager",        level:"—", re:/\b(office\s+manager|admin\s+manager)\b/i,               low:70000,  high:100000},
  {family:"Paralegal / Contracts",  level:"—", re:/\b(paralegal|contracts\s+specialist|contract\s+manager)\b/i, low:95000, high:135000},

  // ---- Commercial / Med Affairs (light heuristics) ----
  {family:"Medical Science Liaison", level:"—", re:/\b(msl|medical\s+science\s+liaison)\b/i,              low:150000, high:200000},
  {family:"Field Applications Scientist", level:"—", re:/\b(field\s+applications?\s+scientist|fas)\b/i,   low:120000, high:165000},
  {family:"Sales (Life Sci AE)",    level:"—", re:/\b(account\s+executive|sales\s+executive|life\s+science\s+sales)\b/i, low:95000, baseHigh=140000, high:140000}, // base only; OTE varies
  {family:"Marketing Manager (Life Sci)", level:"—", re:/\b(marketing\s+manager|product\s+marketing)\b/i, low:115000, high:160000}
].map(r => {
  // Normalize any accidental property like baseHigh in the sales row:
  if (r.baseHigh && !r.high) r.high = r.baseHigh;
  return r;
});

const METRO_MULTIPLIERS = [
  {metro:"Bay Area", re:/\b(san\s+francisco|oakland|san\s+jose|bay\s+area|silicon\s+valley)\b/i, mult:1.25},
  {metro:"NYC", re:/\b(new\s+york|manhattan|brooklyn|nyc|queens)\b/i, mult:1.20},
  {metro:"San Diego", re:/\b(san\s+diego|la\s+jolla)\b/i, mult:1.15},
  {metro:"Seattle", re:/\b(seattle|bellevue|kirkland)\b/i, mult:1.12},
  {metro:"Boston/Cambridge", re:/\b(boston|cambridge|kendall|watertown|waltham|longwood|seaport)\b/i, mult:1.10},
  {metro:"Austin/Denver", re:/\b(austin|denver|boulder)\b/i, mult:1.05},
  {metro:"US Remote / Other", re:/\b(remote|anywhere\s+in\s+the\s+us|united\s+states)\b/i, mult:1.00},
];

function detectRole(text){
  for(const r of ROLE_TABLE){ if(r.re.test(text)) return r; }
  if(/\bassociate\b/i.test(text)) return {family:"Research Associate", level:"(unspecified)", low:80000, high:105000};
  if(/\bscientist\b/i.test(text)) return {family:"Scientist", level:"(unspecified)", low:120000, high:160000};
  if(/\bmanager\b/i.test(text) && /\blab|laboratory\b/i.test(text)) return {family:"Lab Manager", level:"—", low:90000, high:120000};
  return null;
}

function detectMetro(text,url){
  const hay = (text+" "+(url||"")).toLowerCase();
  for(const m of METRO_MULTIPLIERS){ if(m.re.test(hay)) return m; }
  return {metro:"US Remote / Other", mult:1.00};
}

function fmtUSD(n){ return "$"+Math.round(n).toLocaleString(); }

function estimatePay(text,url){
  const role = detectRole(text) || {family:"(role unclear)", level:"—", low:90000, high:120000};
  const metro = detectMetro(text,url);
  const multSel = parseFloat(document.getElementById('m_multiplier').value || metro.mult);
  const low = role.low * multSel;
  const high = role.high * multSel;

  let conf = "Low";
  const roleHit = role.family !== "(role unclear)";
  const metroHit = !!metro.metro;
  if(roleHit && metroHit) conf="High"; else if(roleHit || metroHit) conf="Medium";

  return {role, metro, multUsed:multSel, low, high, confidence:conf};
}

// ------- Analysis -------
function analyze(){
  const text = document.getElementById('jd').value || '';
  const url = document.getElementById('url').value || '';
  if(!text.trim()){ alert('Paste the job ad text first.'); return; }

  const salary = parseSalary(text);
  const benefits = detectBenefits(text);
  const eeo = detectEEO(text);
  const apply = detectApply(text);
  const states = detectStates(text, url);
  const law = lawStatus(states);

  const sSalary = salary.hasAny ? (salary.hasRange?100:70) : 0;
  const sLoc = states.length ? 100 : 50;
  const sBen = benefits ? clamp(50 + 10*benefits, 0, 100) : 30;
  const sEEO = eeo ? 100 : 50;
  const sApply = apply ? 100 : 40;
  const sQuality = salary.hasRange ? 100 : salary.hasAny ? 60 : 0;
  const sLaw = law.score;

  const total = Math.round(
    0.30*sSalary + 0.15*sLoc + 0.15*sBen + 0.10*sEEO + 0.10*sApply + 0.10*sQuality + 0.10*sLaw
  );

  const verdict = total>=85?"Excellent (transparent)": total>=70?"Good (polish suggested)": total>=55?"Needs revision":"High friction (missing salary)";

  function setPair(textId,barId,val,label){ document.getElementById(textId).textContent = label||val+"/100"; bar(barId,val); }
  setPair('s_salary','b_salary',sSalary);
  setPair('s_loc','b_loc',sLoc);
  setPair('s_ben','b_ben',sBen);
  setPair('s_eeo','b_eeo',sEEO);
  setPair('s_apply','b_apply',sApply);
  setPair('s_quality','b_quality',sQuality);
  setPair('s_law','b_law',sLaw, law.label);
  document.getElementById('total').textContent = total;
  document.getElementById('verdict').textContent = verdict;

  const det = document.getElementById('detected');
  det.innerHTML = '';
  const addDet = (label,val)=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML = `<strong>${label}</strong><div class="small muted">${val}</div>`; det.appendChild(d); };
  addDet('States detected', states.length? states.map(s=>STATES[s]).join(', ') : '—');
  addDet('Salary tokens', salary.examples.length? salary.examples.join(' • ') : '—');
  addDet('Hourly/per-year cues', (salary.hasHourly? 'hourly ':'') + (salary.hasPerYear? 'per-year':''));
  addDet('Benefits signals', benefits? benefits+' matches' : 'none');
  addDet('EEO present?', eeo? 'yes' : 'no');
  addDet('Apply path present?', apply? 'yes' : 'no');

  const flags = document.getElementById('flags'); flags.innerHTML='';
  const push = (level,text,fix)=>{ const e=document.createElement('div'); e.className = 'item '+level; e.innerHTML = `<strong>${text}</strong><div class="small muted">${fix}</div>`; flags.appendChild(e); };
  if(!salary.hasAny) push('bad','No salary/range detected.','Add a good-faith base range (min–max) + bonus/equity if applicable.');
  else if(!salary.hasRange) push('warn','Dollar amount found but no min–max range.','Post a range (e.g., $95,000–$115,000) rather than a single number.');
  if(!states.length) push('warn','No clear location.','Add state or remote + time zone / office location. Laws vary by state.');
  if(benefits<2) push('warn','Benefits not clearly described.','Add a one-liner: medical, dental, vision, 401(k), PTO, bonus/equity.');
  if(!eeo) push('warn','Missing EEO/accommodations line.','Add a brief equal-opportunity statement and accommodations contact.');
  if(!apply) push('warn','No application instructions.','Add an “Apply” link or steps (Greenhouse/Lever/Workday) + typical timeline.');
  if(law && law.label.startsWith('Law pending')) push('good','Law not yet effective here.','Post the range now to get ahead of compliance.');

  const est = estimatePay(text,url);
  document.getElementById('m_role').textContent = est.role.family;
  document.getElementById('m_level').textContent = est.role.level;
  document.getElementById('m_metro').textContent = (METRO_MULTIPLIERS.find(m=>m.mult===est.multUsed)?.metro) || est.metro.metro || '—';
  document.getElementById('m_range').textContent = `${fmtUSD(est.low)}–${fmtUSD(est.high)} base`;
  document.getElementById('m_conf').textContent = est.confidence;

  const summary = [
    `Transparency Score: ${total}/100 — ${verdict}`,
    `• Salary shown: ${sSalary}/100 | Location clarity: ${sLoc}/100 | Benefits: ${sBen}/100 | EEO: ${sEEO}/100 | Apply path: ${sApply}/100 | Range quality: ${sQuality}/100`,
    `• Detected states: ${states.length? states.map(s=>STATES[s]).join(', ') : '—'} | Law: ${law.label}${law.detail? ' — '+law.detail:''}`,
    `• Market pay (beta): ${est.role.family} ${est.role.level} in ${document.getElementById('m_metro').textContent}: ${fmtUSD(est.low)}–${fmtUSD(est.high)} base (${est.confidence} confidence)`,
    `${!salary.hasAny? 'Top fix: add a pay range. ': ''}Local-only; no data leaves your browser.`
  ].join('\n');
  document.getElementById('summary').value = summary;

  localStorage.setItem('scf_last', JSON.stringify({text,url}));
}

// ------- Wiring -------
document.getElementById('analyze').addEventListener('click', analyze);
document.getElementById('copy').addEventListener('click', ()=> navigator.clipboard.writeText(document.getElementById('summary').value.trim()));
document.getElementById('clear').addEventListener('click', ()=>{
  document.getElementById('jd').value=''; document.getElementById('url').value='';
  document.getElementById('summary').value='';
  document.querySelectorAll('.bar>span').forEach(s=>s.style.width='0%');
  ['total','s_salary','s_loc','s_ben','s_eeo','s_apply','s_quality','s_law'].forEach(id=>document.getElementById(id).textContent='–');
  document.getElementById('verdict').textContent='Awaiting input';
  document.getElementById('detected').innerHTML=''; document.getElementById('flags').innerHTML='';
  ['m_role','m_level','m_metro','m_range','m_conf'].forEach(id=>document.getElementById(id).textContent='—');
  localStorage.removeItem('scf_last');
});

document.getElementById('m_multiplier').addEventListener('change', ()=>{
  const text = document.getElementById('jd').value || '';
  const url = document.getElementById('url').value || '';
  if(!text.trim()) return;
  const est = estimatePay(text,url);
  document.getElementById('m_range').textContent = `${fmtUSD(est.low)}–${fmtUSD(est.high)} base`;
  document.getElementById('m_conf').textContent = est.confidence;
});

document.getElementById('insertEstimate').addEventListener('click', ()=>{
  const line = document.getElementById('m_range').textContent;
  const role = document.getElementById('m_role').textContent;
  const level = document.getElementById('m_level').textContent;
  const metro = document.getElementById('m_metro').textContent;
  const conf = document.getElementById('m_conf').textContent;
  const add = `Suggested base for ${role} ${level} (${metro}): ${line} (${conf} confidence)`;
  const box = document.getElementById('summary');
  box.value = (box.value.trim() ? box.value.trim()+"\n" : "") + add;
});

document.getElementById('sample').addEventListener('click', ()=>{
  const sample = `Research Associate II — Cell Biology\n\nLocation: Boston, MA (hybrid, 3 days on-site)\n\nAbout the role\nYou will run cell-based assays, maintain mammalian cell lines, and contribute to pipeline experiments.\n\nCompensation\nBase salary range: $95,000–$115,000 plus 10% bonus; equity eligible. \nBenefits include medical, dental, vision, 401(k), and generous PTO.\n\nHow to apply\nApply via our Lever page. Typical process: intro → panel → offer in ~2 weeks.\n\nEEO\nWe are an equal opportunity employer and provide reasonable accommodations for candidates with disabilities.`;
  document.getElementById('jd').value = sample;
  document.getElementById('url').value = 'https://jobs.example.com/boston-ma/research-associate-ii';
});

try{ const last = JSON.parse(localStorage.getItem('scf_last')||'null'); if(last){ document.getElementById('jd').value=last.text||''; document.getElementById('url').value=last.url||''; } }catch(e){}
</script>
</body>
</html>
